<?xml version="1.0" encoding="ISO-8859-1"?>

<bugs>
	<bug>
		<id>28340</id>
		<title>ES shut down with JVM crash from  unified highlighter</title>
		<body>&lt;!-- Bug report --&gt;  **Elasticsearch version** (`bin/elasticsearch --version`): 6.2.0 BC1  **Plugins installed**: None  **JVM version** (`java -version`):  **OS version** (`uname -a` if on a Unix-like system): Darwin Kernel Version 15.6.0: Sun Jun  4 21:43:07 PDT 2017; root:xnu-3248.70.3~1/RELEASE_X86_64 x86_64  **Description of the problem including expected versus actual behavior**: ES shut down all of a sudden with a fatal error in logs. I was testing index pattern creation in Safari/Firefox and chrome in Kibana. Both safari and firefox restarted (?).    **Steps to reproduce**:  Please include a *minimal* but *complete* recreation of the problem, including (e.g.) index creation, mappings, settings, query etc.  The easier you make for us to reproduce it, the more likely that somebody will take the time to look at it.   1. Load ES/Kibana/Metricbeat of BC1 of 6.2.0 with metricbeat indexpattern and dashboards loaded  2. Try to create and recreate metricbeat index pattern in Kibana multiple times  3. Noticed that ES crashed at one point.  **Provide logs (if relevant)**: ES logs:  ``` [2018-01-22T12:47:29,344][INFO ][o.e.c.s.MasterService    ] [SanPFt1] zen-disco-elected-as-master ([0] nodes joined), reason: new_master {SanPFt1}{SanPFt1mQjeKHVG6oJ6NJA}{kZ_rCjSGQEyJb1X0JDLHrA}{127.0.0.1}{127.0.0.1:9300} [2018-01-22T12:47:29,349][INFO ][o.e.c.s.ClusterApplierService] [SanPFt1] new_master {SanPFt1}{SanPFt1mQjeKHVG6oJ6NJA}{kZ_rCjSGQEyJb1X0JDLHrA}{127.0.0.1}{127.0.0.1:9300}, reason: apply cluster state (from master [master {SanPFt1}{SanPFt1mQjeKHVG6oJ6NJA}{kZ_rCjSGQEyJb1X0JDLHrA}{127.0.0.1}{127.0.0.1:9300} committed version [1] source [zen-disco-elected-as-master ([0] nodes joined)]]) [2018-01-22T12:47:29,374][INFO ][o.e.h.n.Netty4HttpServerTransport] [SanPFt1] publish_address {127.0.0.1:9200}, bound_addresses {[::1]:9200}, {127.0.0.1:9200} [2018-01-22T12:47:29,374][INFO ][o.e.n.Node               ] [SanPFt1] started [2018-01-22T12:47:29,726][INFO ][o.e.g.GatewayService     ] [SanPFt1] recovered [2] indices into cluster_state [2018-01-22T12:47:30,249][INFO ][o.e.c.r.a.AllocationService] [SanPFt1] Cluster health status changed from [RED] to [YELLOW] (reason: [shards started [[.kibana][0]] ...]). [2018-01-23T00:00:08,359][INFO ][o.e.c.m.MetaDataCreateIndexService] [SanPFt1] [metricbeat-6.2.0-2018.01.23] creating index, cause [auto(bulk api)], templates [metricbeat-6.2.0], shards [1]/[1], mappings [doc] # # A fatal error has been detected by the Java Runtime Environment: # #  SIGSEGV (0xb) at pc=0x000000010d6b85d3, pid=1172, tid=0x0000000000004603 # # JRE version: Java(TM) SE Runtime Environment (8.0_111-b14) (build 1.8.0_111-b14) # Java VM: Java HotSpot(TM) 64-Bit Server VM (25.111-b14 mixed mode bsd-amd64 compressed oops) # Problematic frame: # V  [libjvm.dylib+0x2b85d3]  InstanceKlass::remove_dependent_nmethod(nmethod*, bool)+0xc7 # # Failed to write core dump. Core dumps have been disabled. To enable core dumping, try "ulimit -c unlimited" before starting Java again # # An error report file with more information is saved as: # /Users/bhavyarajumandya/Desktop/BC1_6.2.0/elasticsearch-6.2.0/hs_err_pid1172.log Compiled method (c2) 45804036 9121       4       org.apache.lucene.search.uhighlight.UnifiedHighlighter::highlightFieldsAsObjects (572 bytes)  total in heap  [0x000000010ed26610,0x000000010ed47a60] = 136272  relocation     [0x000000010ed26738,0x000000010ed271f8] = 2752  constants      [0x000000010ed27200,0x000000010ed27220] = 32  main code      [0x000000010ed27220,0x000000010ed30d20] = 39680  stub code      [0x000000010ed30d20,0x000000010ed310c8] = 936  oops           [0x000000010ed310c8,0x000000010ed311c0] = 248  metadata       [0x000000010ed311c0,0x000000010ed31830] = 1648  scopes data    [0x000000010ed31830,0x000000010ed45338] = 80648  scopes pcs     [0x000000010ed45338,0x000000010ed469b8] = 5760  dependencies   [0x000000010ed469b8,0x000000010ed46a78] = 192  handler table  [0x000000010ed46a78,0x000000010ed47840] = 3528  nul chk table  [0x000000010ed47840,0x000000010ed47a60] = 544 # # If you would like to submit a bug report, please visit: #   http://bugreport.java.com/bugreport/crash.jsp # Abort trap: 6 ```  **Kibana dev console:**  &lt;img width="1280" alt="console_dev" src="https://user-images.githubusercontent.com/7074629/35278117-00d6de94-0017-11e8-9dc0-e09875d916e7.png"&gt;  hs_err_pid1172.log: [hs_err_pid1172.log](https://github.com/elastic/elasticsearch/files/1656076/hs_err_pid1172.log)    </body>
		<created>2018-01-23 13:30:51</created>
		<closed>2018-01-31 13:23:13</closed>
	</bug>
	<bug>
		<id>17171</id>
		<title>elasticsearch does not start / gradle build totally broken with JDK 9 build 110</title>
		<body>With the latest java 9 ea (110), a compiled version will not work at all. Maybe we are doing something illegal/sheisty to retrieve the PID, maybe its a bug.  ``` rmuir@beast:~/workspace/elasticsearch/distribution/zip/build/distributions/elasticsearch-5.0.0-SNAPSHOT$ bin/elasticsearch Java HotSpot(TM) 64-Bit Server VM warning: Option UseParNewGC was deprecated in version 9.0 and will likely be removed in a future release. Exception in thread "main" java.lang.NoClassDefFoundError: Could not initialize class java.lang.management.ManagementFactory$PlatformMBeanFinder     at java.lang.management.ManagementFactory.getPlatformMXBean(ManagementFactory.java:649)     at java.lang.management.ManagementFactory.getRuntimeMXBean(ManagementFactory.java:355)     at org.elasticsearch.monitor.jvm.JvmInfo.&lt;clinit&gt;(JvmInfo.java:53)     at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:245)     at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:108)     at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:103)     at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:88)     at org.elasticsearch.cli.Command.main(Command.java:53)     at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:74)     at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:67) Refer to the log for complete error details. ```  Also gradle itself eats it early and does not work at all:  ``` rmuir@beast:~/workspace/elasticsearch$ gradle --stacktrace clean  FAILURE: Build failed with an exception.  * What went wrong: sun.management.spi.PlatformMBeanProvider: Provider jdk.management.cmm.internal.PlatformMBeanProviderImpl not found  * Try: Run with --info or --debug option to get more log output.  * Exception is: java.util.ServiceConfigurationError: sun.management.spi.PlatformMBeanProvider: Provider jdk.management.cmm.internal.PlatformMBeanProviderImpl not found     at java.util.ServiceLoader.fail(ServiceLoader.java:237)     at java.util.ServiceLoader.access$300(ServiceLoader.java:183)     at java.util.ServiceLoader$LazyIterator.nextService(ServiceLoader.java:370)     at java.util.ServiceLoader$LazyIterator.next(ServiceLoader.java:402)     at java.util.ServiceLoader$1.next(ServiceLoader.java:478)     at java.lang.Iterable.forEach(Iterable.java:74)     at java.lang.management.ManagementFactory$PlatformMBeanFinder.lambda$static$0(ManagementFactory.java:890)     at java.security.AccessController.doPrivileged(Native Method)     at java.security.AccessController.doPrivileged(AccessController.java:428)     at java.lang.management.ManagementFactory$PlatformMBeanFinder.&lt;clinit&gt;(ManagementFactory.java:886)     at java.lang.management.ManagementFactory.getPlatformMXBean(ManagementFactory.java:649)     at java.lang.management.ManagementFactory.getRuntimeMXBean(ManagementFactory.java:355)     at org.gradle.launcher.daemon.configuration.CurrentProcess.inferJvmOptions(CurrentProcess.java:71)     at org.gradle.launcher.daemon.configuration.CurrentProcess.&lt;init&gt;(CurrentProcess.java:33)     at org.gradle.launcher.cli.BuildActionsFactory.canUseCurrentProcess(BuildActionsFactory.java:95)     at org.gradle.launcher.cli.BuildActionsFactory.createAction(BuildActionsFactory.java:72)     at org.gradle.launcher.cli.CommandLineActionFactory$ParseAndBuildAction.createAction(CommandLineActionFactory.java:242)     at org.gradle.launcher.cli.CommandLineActionFactory$ParseAndBuildAction.execute(CommandLineActionFactory.java:232)     at org.gradle.launcher.cli.CommandLineActionFactory$ParseAndBuildAction.execute(CommandLineActionFactory.java:210)     at org.gradle.launcher.cli.JavaRuntimeValidationAction.execute(JavaRuntimeValidationAction.java:35)     at org.gradle.launcher.cli.JavaRuntimeValidationAction.execute(JavaRuntimeValidationAction.java:24)     at org.gradle.launcher.cli.CommandLineActionFactory$WithLogging.execute(CommandLineActionFactory.java:206)     at org.gradle.launcher.cli.CommandLineActionFactory$WithLogging.execute(CommandLineActionFactory.java:169)     at org.gradle.launcher.cli.ExceptionReportingAction.execute(ExceptionReportingAction.java:33)     at org.gradle.launcher.cli.ExceptionReportingAction.execute(ExceptionReportingAction.java:22)     at org.gradle.launcher.Main.doAction(Main.java:33)     at org.gradle.launcher.bootstrap.EntryPoint.run(EntryPoint.java:45)     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)     at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)     at java.lang.reflect.Method.invoke(Method.java:520)     at org.gradle.launcher.bootstrap.ProcessBootstrap.runNoExit(ProcessBootstrap.java:54)     at org.gradle.launcher.bootstrap.ProcessBootstrap.run(ProcessBootstrap.java:35)     at org.gradle.launcher.GradleMain.main(GradleMain.java:23) ``` </body>
		<created>2016-03-17 15:11:46</created>
		<closed>2018-03-12 22:39:12</closed>
	</bug>
	<bug>
		<id>12914</id>
		<title>multicast is sent over all interfaces by default</title>
		<body>Migration guide says:  Elasticsearch now binds to the loopback interface by default (usually `127.0.0.1` or `::1`). The `network.host` setting can be specified to change this behavior.  But this is a little confusing, because it still sends multicast packets over all interfaces (224.2.2.4). Instead, when we are only bound to loopback interface, I think we should use a link-local scoped address (e.g. 224.0.0.x). Ideally we'd use node-local if ipv4 had it (nodes bound to different loopback interfaces won't see each other). ipv6 can do node-local though.  Just startup another node on the same network with -Des.network.host=&lt;realip&gt; and you will see that it gets multicast packets from the other machine (of course things don't work, since its advertising localhost):  [2015-08-15 22:19:45,835][WARN ][org.elasticsearch.discovery.zen.ping.multicast] [Lorna Dane] failed to connect to requesting node [Locksmith][ywu92vT0Q0OYRNo-EmK01w][mac2][inet[/127.0.0.1:9300]] ConnectTransportException[[Locksmith][inet[/127.0.0.1:9300]] connect_timeout[30s]]; nested: ConnectException[Connection refused: /127.0.0.1:9300];     at org.elasticsearch.transport.netty.NettyTransport.connectToChannels(NettyTransport.java:827)     at org.elasticsearch.transport.netty.NettyTransport.connectToNode(NettyTransport.java:760)     at org.elasticsearch.transport.netty.NettyTransport.connectToNode(NettyTransport.java:733)     at org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:234)     at org.elasticsearch.discovery.zen.ping.multicast.MulticastZenPing$Receiver$1.run(MulticastZenPing.java:537)     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)     at java.lang.Thread.run(Thread.java:745) Caused by: java.net.ConnectException: Connection refused: /127.0.0.1:9300     at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)     at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)     at org.jboss.netty.channel.socket.nio.NioClientBoss.connect(NioClientBoss.java:152)     at org.jboss.netty.channel.socket.nio.NioClientBoss.processSelectedKeys(NioClientBoss.java:105)     at org.jboss.netty.channel.socket.nio.NioClientBoss.process(NioClientBoss.java:79)     at org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:337)     at org.jboss.netty.channel.socket.nio.NioClientBoss.run(NioClientBoss.java:42)     at org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)     at org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)     ... 3 more  Try the same scenario with `bin/elasticsearch -Ddiscovery.zen.ping.multicast.group=224.0.0.200` and you can bring up multiple instances on one machine, but you won't see these pings from another machine. With mac at least there is an issue, and even changing the address here does not work... </body>
		<created>2015-08-16 02:46:25</created>
		<closed>2015-08-19 11:58:57</closed>
	</bug>
</bugs>
